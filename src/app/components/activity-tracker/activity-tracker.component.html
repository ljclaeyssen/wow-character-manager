<div class="activity-tracker-container">
  @if (selectedCharacter()) {
    <div class="character-header">
      <h2>{{ selectedCharacter()!.name }} - Weekly Progress</h2>
      <div class="reset-info">
        <i class="pi pi-clock"></i>
        <span>Reset in: {{ timeUntilReset() }}</span>
        <p-button
          icon="pi pi-refresh"
          [text]="true"
          size="small"
          pTooltip="Refresh Data"
          (onClick)="onRefreshData()">
        </p-button>
      </div>
    </div>

    <div class="tracker-grid">
      <!-- Great Vault Progress Row -->
      <div class="vault-progress-row">
        <p-card header="Activities" styleClass="vault-progress-card">

        <div class="vault-sources">
          <div class="vault-source">
            <div class="source-header">
              <i class="pi pi-trophy raid-icon"></i>
              <span class="source-label">Raid</span>
              <p-badge
                [value]="vaultProgress().raid + '/3'"
                [severity]="getProgressSeverity(weeklyProgress().raidProgress)">
              </p-badge>
            </div>
            <p-progressBar
              [value]="weeklyProgress().raidProgress"
              [showValue]="false"
              styleClass="source-progress">
            </p-progressBar>

            <!-- Quick Add Buttons -->
            <div class="quick-add-buttons" style="margin-top: 8px; display: flex; gap: 4px; flex-wrap: wrap;">
              <button
                class="wow-button lfr-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddLFRBoss()"
                title="Add LFR boss kill">
                <i class="pi pi-plus"></i> LFR
              </button>

              <button
                class="wow-button normal-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddNormalBoss()"
                title="Add Normal boss kill">
                <i class="pi pi-plus"></i> Normal
              </button>

              <button
                class="wow-button heroic-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddHeroicBoss()"
                title="Add Heroic boss kill">
                <i class="pi pi-plus"></i> Heroic
              </button>

              <button
                class="wow-button mythic-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddMythicBoss()"
                title="Add Mythic boss kill">
                <i class="pi pi-plus"></i> Mythic
              </button>
            </div>
          </div>

          <div class="vault-source">
            <div class="source-header">
              <i class="pi pi-compass mythic-plus-icon"></i>
              <span class="source-label">Mythic+</span>
              <p-badge
                [value]="vaultProgress().mythicPlus + '/3'"
                [severity]="getProgressSeverity(weeklyProgress().mythicPlusProgress)">
              </p-badge>
            </div>
            <p-progressBar
              [value]="weeklyProgress().mythicPlusProgress"
              [showValue]="false"
              styleClass="source-progress">
            </p-progressBar>

            <!-- Quick Add Buttons -->
            <div class="quick-add-buttons" style="margin-top: 8px; display: flex; gap: 4px;">
              <button
                class="wow-button heroic-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddLowLevelRun()"
                title="Add run below {{ MYTHIC_LOOT_THRESHOLD }} (Heroic vault reward)">
                <i class="pi pi-plus"></i> <{{ MYTHIC_LOOT_THRESHOLD }}
              </button>

              <button
                class="wow-button mythic-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddHighLevelRun()"
                title="Add run {{ MYTHIC_LOOT_THRESHOLD }}+ (Mythic vault reward)">
                <i class="pi pi-plus"></i> â‰¥{{ MYTHIC_LOOT_THRESHOLD }}
              </button>
            </div>
          </div>

          <div class="vault-source">
            <div class="source-header">
              <i class="pi pi-flag pvp-icon"></i>
              <span class="source-label">PvP</span>
              <p-badge
                [value]="vaultProgress().pvp + '/3'"
                [severity]="getProgressSeverity(weeklyProgress().pvpProgress)">
              </p-badge>
            </div>
            <p-progressBar
              [value]="weeklyProgress().pvpProgress"
              [showValue]="false"
              styleClass="source-progress">
            </p-progressBar>
            <small class="source-requirement">5/10/15 wins for slots</small>
          </div>
        </div>
      </p-card>


      <!-- Great Vault Progress -->
      <p-card header="Great Vault Progress" styleClass="vault-progress-card">
        <div class="vault-header">
          <span class="vault-title">Mythic+</span>
          <span class="vault-slots">{{ mythicPlusVaultProgress().slots }}/3 slots</span>
        </div>

        <div class="vault-rewards-row">
          <p-tag
            [value]="mythicPlusVaultProgress().slotRewards[0]"
            [severity]="mythicPlusVaultProgress().slotRewards[0] === 'Mythic' ? 'warn' : mythicPlusVaultProgress().slotRewards[0] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
          <p-tag
            [value]="mythicPlusVaultProgress().slotRewards[1]"
            [severity]="mythicPlusVaultProgress().slotRewards[1] === 'Mythic' ? 'warn' : mythicPlusVaultProgress().slotRewards[1] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
          <p-tag
            [value]="mythicPlusVaultProgress().slotRewards[2]"
            [severity]="mythicPlusVaultProgress().slotRewards[2] === 'Mythic' ? 'warn' : mythicPlusVaultProgress().slotRewards[2] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
        </div>

        @if (mythicPlusVaultProgress().nextMilestone.remaining > 0) {
          <p-message
            severity="info"
            styleClass="milestone-message">
            <span>{{ mythicPlusVaultProgress().nextMilestone.remaining }} more runs needed for next vault slot</span>
          </p-message>
        } @else {
          <p-message
            severity="success"
            styleClass="milestone-message">
            <span>All Mythic+ vault slots earned this week!</span>
          </p-message>
        }

        <p-divider></p-divider>

        <!-- Raid Section -->
        <div class="vault-header">
          <span class="vault-title">Raid</span>
          <span class="vault-slots">{{ raidVaultProgress().slots }}/3 slots</span>
        </div>

        <div class="vault-rewards-row">
          <p-tag
            [value]="raidVaultProgress().slotRewards[0]"
            [severity]="raidVaultProgress().slotRewards[0] === 'Mythic' ? 'warn' : raidVaultProgress().slotRewards[0] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
          <p-tag
            [value]="raidVaultProgress().slotRewards[1]"
            [severity]="raidVaultProgress().slotRewards[1] === 'Mythic' ? 'warn' : raidVaultProgress().slotRewards[1] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
          <p-tag
            [value]="raidVaultProgress().slotRewards[2]"
            [severity]="raidVaultProgress().slotRewards[2] === 'Mythic' ? 'warn' : raidVaultProgress().slotRewards[2] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
        </div>

        @if (raidVaultProgress().nextMilestone.remaining > 0) {
          <p-message
            severity="info"
            styleClass="milestone-message">
            <span>{{ raidVaultProgress().nextMilestone.remaining }} more bosses needed for next vault slot</span>
          </p-message>
        } @else {
          <p-message
            severity="success"
            styleClass="milestone-message">
            <span>All Raid vault slots earned this week!</span>
          </p-message>
        }
      </p-card>
      </div>

      <!-- Weekly Quests Section -->
      <div class="weekly-quests-row">
        <!-- Left Column: World Content -->
        <p-card header="Weekly World Content" styleClass="world-content-card">

          <!-- World Boss -->
          <div class="quest-item">
            <div class="quest-info">
              <i class="pi pi-globe quest-icon world-boss-icon"></i>
              <div class="quest-details">
                <span class="quest-name">World Boss</span>
                <small class="quest-description">Defeat the weekly world boss for loot</small>
              </div>
            </div>
            <p-button
              [icon]="worldBossCompleted() ? 'pi pi-check' : 'pi pi-plus'"
              [severity]="worldBossCompleted() ? 'success' : 'secondary'"
              [outlined]="!worldBossCompleted()"
              [text]="false"
              [rounded]="true"
              size="small"
              [disabled]="loading()"
              [pTooltip]="worldBossCompleted() ? 'Mark as incomplete' : 'Mark as complete'"
              (onClick)="onToggleWorldBoss()">
            </p-button>
          </div>

          <!-- Spark Fragment -->
          <div class="quest-item">
            <div class="quest-info">
              <i class="pi pi-star quest-icon spark-icon"></i>
              <div class="quest-details">
                <span class="quest-name">Spark Fragment</span>
                <small class="quest-description">Complete weekly spark fragment quest</small>
              </div>
            </div>
            <p-button
              [icon]="sparkQuestCompleted() ? 'pi pi-check' : 'pi pi-plus'"
              [severity]="sparkQuestCompleted() ? 'success' : 'secondary'"
              [outlined]="!sparkQuestCompleted()"
              [text]="false"
              [rounded]="true"
              size="small"
              [disabled]="loading()"
              [pTooltip]="sparkQuestCompleted() ? 'Mark as incomplete' : 'Mark as complete'"
              (onClick)="onToggleSparkQuest()">
            </p-button>
          </div>

          <!-- Weekly Event -->
          <div class="quest-item">
            <div class="quest-info">
              <i class="pi pi-calendar quest-icon event-icon"></i>
              <div class="quest-details">
                <span class="quest-name">{{ currentWeekEvent }}</span>
                <small class="quest-description">Complete this week's bonus event</small>
              </div>
            </div>
            <p-button
              [icon]="weeklyEventCompleted() ? 'pi pi-check' : 'pi pi-plus'"
              [severity]="weeklyEventCompleted() ? 'success' : 'secondary'"
              [outlined]="!weeklyEventCompleted()"
              [text]="false"
              [rounded]="true"
              size="small"
              [disabled]="loading()"
              [pTooltip]="weeklyEventCompleted() ? 'Mark as incomplete' : 'Mark as complete'"
              (onClick)="onToggleWeeklyEvent()">
            </p-button>
          </div>

          <!-- Quest Summary -->
          @if (worldBossCompleted() && sparkQuestCompleted() && weeklyEventCompleted()) {
            <p-message
              severity="success"
              styleClass="quest-complete-message">
              <span>All weekly content completed!</span>
            </p-message>
          }
        </p-card>

        <!-- Right Column: Profession Knowledge -->
        <p-card header="Profession Knowledge" styleClass="profession-knowledge-card">
          @if (selectedCharacter()?.professions && selectedCharacter()!.professions.length > 0) {

            <div class="profession-quest-grid">
              @for (prof of professionQuestProgress(); track prof.profession) {
                <div class="profession-quest-item" [class.completed]="prof.completed">
                  <div class="profession-icon-wrapper">
                    <img
                      [src]="getProfessionIcon(prof.profession)"
                      [alt]="prof.profession"
                      class="profession-icon"
                      [class.completed]="prof.completed">
                  </div>
                  <div class="profession-details">
                    <span class="profession-name">{{ prof.profession }}</span>
                    <small class="profession-description">{{ prof.description }}</small>
                  </div>
                  <div class="profession-action">
                    <p-button
                      [icon]="prof.completed ? 'pi pi-check' : 'pi pi-plus'"
                      [severity]="prof.completed ? 'success' : 'secondary'"
                      [outlined]="!prof.completed"
                      [text]="false"
                      [rounded]="true"
                      size="small"
                      [disabled]="loading()"
                      [pTooltip]="prof.completed ? 'Mark as incomplete' : 'Mark as complete'"
                      (onClick)="onToggleProfessionQuest(prof.profession)">
                    </p-button>
                  </div>
                </div>
              }
            </div>

            @if (allProfessionQuestsCompleted()) {
              <p-message
                severity="success"
                styleClass="profession-complete-message">
                <span>All profession knowledge quests completed!</span>
              </p-message>
            }
          } @else {
            <div class="no-professions">
              <i class="pi pi-briefcase"></i>
              <h4>No Professions</h4>
              <p>This character doesn't have any professions yet.</p>
            </div>
          }
        </p-card>
      </div>

    </div>
  } @else {
    <div class="no-character-selected">
      <p-card>
        <div class="empty-state">
          <i class="pi pi-user-plus"></i>
          <h3>No Character Selected</h3>
          <p>Select a character to view their weekly activity progress and Great Vault status.</p>
        </div>
      </p-card>
    </div>
  }

  @if (loading()) {
    <div class="loading-overlay">
      <i class="pi pi-spin pi-spinner"></i>
      <span>Loading activity data...</span>
    </div>
  }
</div>