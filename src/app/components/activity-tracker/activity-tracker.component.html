<div class="activity-tracker-container">
  @if (selectedCharacter()) {
    <div class="character-header">
      <h2>{{ selectedCharacter()!.name }} - Weekly Progress</h2>
      <div class="reset-info">
        <i class="pi pi-clock"></i>
        <span>Reset in: {{ timeUntilReset() }}</span>
        <p-button
          icon="pi pi-refresh"
          [text]="true"
          size="small"
          pTooltip="Refresh Data"
          (onClick)="onRefreshData()">
        </p-button>
      </div>
    </div>

    <div class="tracker-grid">
      <!-- Great Vault Progress Card -->
      <p-card header="Great Vault Progress" styleClass="vault-progress-card">
        <div class="vault-summary">
          <div class="vault-total">
            <span class="vault-slots">{{ vaultProgress().total }}/9</span>
            <span class="vault-label">Vault Slots</span>
          </div>
          <p-progressBar
            [value]="vaultProgressPercentage()"
            [showValue]="false"
            styleClass="vault-main-progress">
          </p-progressBar>
        </div>

        <p-divider></p-divider>

        <div class="vault-sources">
          <div class="vault-source">
            <div class="source-header">
              <i class="pi pi-trophy raid-icon"></i>
              <span class="source-label">Raid</span>
              <p-badge
                [value]="vaultProgress().raid + '/3'"
                [severity]="getProgressSeverity(weeklyProgress().raidProgress)">
              </p-badge>
            </div>
            <p-progressBar
              [value]="weeklyProgress().raidProgress"
              [showValue]="false"
              styleClass="source-progress">
            </p-progressBar>

            <!-- Quick Add Buttons -->
            <div class="quick-add-buttons" style="margin-top: 8px; display: flex; gap: 4px; flex-wrap: wrap;">
              <button
                class="wow-button lfr-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddLFRBoss()"
                title="Add LFR boss kill">
                <i class="pi pi-plus"></i> LFR
              </button>

              <button
                class="wow-button normal-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddNormalBoss()"
                title="Add Normal boss kill">
                <i class="pi pi-plus"></i> Normal
              </button>

              <button
                class="wow-button heroic-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddHeroicBoss()"
                title="Add Heroic boss kill">
                <i class="pi pi-plus"></i> Heroic
              </button>

              <button
                class="wow-button mythic-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddMythicBoss()"
                title="Add Mythic boss kill">
                <i class="pi pi-plus"></i> Mythic
              </button>
            </div>
          </div>

          <div class="vault-source">
            <div class="source-header">
              <i class="pi pi-compass mythic-plus-icon"></i>
              <span class="source-label">Mythic+</span>
              <p-badge
                [value]="vaultProgress().mythicPlus + '/3'"
                [severity]="getProgressSeverity(weeklyProgress().mythicPlusProgress)">
              </p-badge>
            </div>
            <p-progressBar
              [value]="weeklyProgress().mythicPlusProgress"
              [showValue]="false"
              styleClass="source-progress">
            </p-progressBar>

            <!-- Quick Add Buttons -->
            <div class="quick-add-buttons" style="margin-top: 8px; display: flex; gap: 4px;">
              <button
                class="wow-button heroic-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddLowLevelRun()"
                title="Add run below {{ MYTHIC_LOOT_THRESHOLD }} (Heroic vault reward)">
                <i class="pi pi-plus"></i> <{{ MYTHIC_LOOT_THRESHOLD }}
              </button>

              <button
                class="wow-button mythic-button"
                [disabled]="!selectedCharacter() || loading()"
                (click)="onAddHighLevelRun()"
                title="Add run {{ MYTHIC_LOOT_THRESHOLD }}+ (Mythic vault reward)">
                <i class="pi pi-plus"></i> â‰¥{{ MYTHIC_LOOT_THRESHOLD }}
              </button>
            </div>
          </div>

          <div class="vault-source">
            <div class="source-header">
              <i class="pi pi-flag pvp-icon"></i>
              <span class="source-label">PvP</span>
              <p-badge
                [value]="vaultProgress().pvp + '/3'"
                [severity]="getProgressSeverity(weeklyProgress().pvpProgress)">
              </p-badge>
            </div>
            <p-progressBar
              [value]="weeklyProgress().pvpProgress"
              [showValue]="false"
              styleClass="source-progress">
            </p-progressBar>
            <small class="source-requirement">5/10/15 wins for slots</small>
          </div>
        </div>
      </p-card>

      <!-- Activity Summary Card -->
      <p-card header="Weekly Activity Summary" styleClass="activity-summary-card">
        <div class="activity-stats">
          <div class="stat-item">
            <i class="pi pi-chart-bar"></i>
            <div class="stat-content">
              <span class="stat-value">{{ activityStats().totalActivities }}</span>
              <span class="stat-label">Total Activities</span>
            </div>
          </div>

          <div class="stat-item">
            <i class="pi pi-compass"></i>
            <div class="stat-content">
              <span class="stat-value">{{ activityStats().mythicPlusCompleted }}</span>
              <span class="stat-label">M+ Completed</span>
            </div>
          </div>

          <div class="stat-item">
            <i class="pi pi-trophy"></i>
            <div class="stat-content">
              <span class="stat-value">{{ activityStats().raidsCompleted }}</span>
              <span class="stat-label">Raid Bosses</span>
            </div>
          </div>

          <div class="stat-item">
            <i class="pi pi-flag"></i>
            <div class="stat-content">
              <span class="stat-value">{{ activityStats().pvpMatches }}</span>
              <span class="stat-label">PvP Matches</span>
            </div>
          </div>

          <div class="stat-item">
            <i class="pi pi-bookmark"></i>
            <div class="stat-content">
              <span class="stat-value">{{ activityStats().questsCompleted }}</span>
              <span class="stat-label">Quests</span>
            </div>
          </div>

          <div class="stat-item">
            <i class="pi pi-star"></i>
            <div class="stat-content">
              <span class="stat-value">{{ activityStats().achievementsEarned }}</span>
              <span class="stat-label">Achievements</span>
            </div>
          </div>
        </div>
      </p-card>

      <!-- Great Vault Progress -->
      <p-card header="Great Vault Progress" styleClass="vault-progress-card">
        <div class="vault-header">
          <span class="vault-title">Mythic+</span>
          <span class="vault-slots">{{ mythicPlusVaultProgress().slots }}/3 slots</span>
        </div>

        <div class="vault-rewards-row">
          <p-tag
            [value]="mythicPlusVaultProgress().slotRewards[0]"
            [severity]="mythicPlusVaultProgress().slotRewards[0] === 'Mythic' ? 'warn' : mythicPlusVaultProgress().slotRewards[0] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
          <p-tag
            [value]="mythicPlusVaultProgress().slotRewards[1]"
            [severity]="mythicPlusVaultProgress().slotRewards[1] === 'Mythic' ? 'warn' : mythicPlusVaultProgress().slotRewards[1] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
          <p-tag
            [value]="mythicPlusVaultProgress().slotRewards[2]"
            [severity]="mythicPlusVaultProgress().slotRewards[2] === 'Mythic' ? 'warn' : mythicPlusVaultProgress().slotRewards[2] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
        </div>

        @if (mythicPlusVaultProgress().nextMilestone.remaining > 0) {
          <p-message
            severity="info"
            styleClass="milestone-message">
            <span>{{ mythicPlusVaultProgress().nextMilestone.remaining }} more runs needed for next vault slot</span>
          </p-message>
        } @else {
          <p-message
            severity="success"
            styleClass="milestone-message">
            <span>All Mythic+ vault slots earned this week!</span>
          </p-message>
        }

        <p-divider></p-divider>

        <!-- Raid Section -->
        <div class="vault-header">
          <span class="vault-title">Raid</span>
          <span class="vault-slots">{{ raidVaultProgress().slots }}/3 slots</span>
        </div>

        <div class="vault-rewards-row">
          <p-tag
            [value]="raidVaultProgress().slotRewards[0]"
            [severity]="raidVaultProgress().slotRewards[0] === 'Mythic' ? 'warn' : raidVaultProgress().slotRewards[0] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
          <p-tag
            [value]="raidVaultProgress().slotRewards[1]"
            [severity]="raidVaultProgress().slotRewards[1] === 'Mythic' ? 'warn' : raidVaultProgress().slotRewards[1] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
          <p-tag
            [value]="raidVaultProgress().slotRewards[2]"
            [severity]="raidVaultProgress().slotRewards[2] === 'Mythic' ? 'warn' : raidVaultProgress().slotRewards[2] === 'Heroic' ? 'info' : 'secondary'"
            size="small">
          </p-tag>
        </div>

        @if (raidVaultProgress().nextMilestone.remaining > 0) {
          <p-message
            severity="info"
            styleClass="milestone-message">
            <span>{{ raidVaultProgress().nextMilestone.remaining }} more bosses needed for next vault slot</span>
          </p-message>
        } @else {
          <p-message
            severity="success"
            styleClass="milestone-message">
            <span>All Raid vault slots earned this week!</span>
          </p-message>
        }
      </p-card>

      <!-- Weekly Quests Section -->
      <p-card header="Weekly Quests" styleClass="weekly-quests-card">
        <div class="weekly-quest-header">
          <div class="quest-progress-summary">
            <span class="quest-completed">{{ weeklyQuestProgress().completed }}/{{ weeklyQuestProgress().total }}</span>
            <span class="quest-label">Quests Completed</span>
          </div>
          <p-progressBar
            [value]="weeklyQuestProgress().percentage"
            [showValue]="false"
            styleClass="quest-progress-bar">
          </p-progressBar>
        </div>

        <p-divider></p-divider>

        <!-- World Boss -->
        <div class="quest-item">
          <div class="quest-info">
            <i class="pi pi-globe quest-icon"></i>
            <div class="quest-details">
              <span class="quest-name">World Boss</span>
              <small class="quest-description">Defeat the weekly world boss</small>
            </div>
          </div>
          <p-checkbox
            [ngModel]="worldBossCompleted()"
            [binary]="true"
            [disabled]="loading()"
            (onChange)="onToggleWorldBoss()">
          </p-checkbox>
        </div>

        <!-- Spark Fragment -->
        <div class="quest-item">
          <div class="quest-info">
            <i class="pi pi-star quest-icon"></i>
            <div class="quest-details">
              <span class="quest-name">Spark Fragment</span>
              <small class="quest-description">{{ sparkProgress().current }}/{{ sparkProgress().max }} fragments (2 weeks = 1 spark)</small>
            </div>
          </div>
          <div class="spark-controls">
            <p-progressBar
              [value]="sparkProgress().percentage"
              [showValue]="false"
              styleClass="spark-mini-progress">
            </p-progressBar>
            <p-button
              [icon]="sparkProgress().current > 0 ? 'pi pi-minus' : 'pi pi-plus'"
              [severity]="sparkProgress().current > 0 ? 'danger' : 'success'"
              [text]="true"
              [rounded]="true"
              size="small"
              (onClick)="onToggleSparkQuest()">
            </p-button>
          </div>
        </div>

        <!-- Weekly Event -->
        <div class="quest-item">
          <div class="quest-info">
            <i class="pi pi-calendar quest-icon"></i>
            <div class="quest-details">
              <span class="quest-name">{{ currentWeekEvent }}</span>
              <small class="quest-description">Complete the weekly bonus event</small>
            </div>
          </div>
          <p-checkbox
            [ngModel]="weeklyEventCompleted()"
            [binary]="true"
            [disabled]="loading()"
            (onChange)="onToggleWeeklyEvent()">
          </p-checkbox>
        </div>

        <!-- Profession Quests -->
        @if (selectedCharacter()?.professions && selectedCharacter()!.professions.length > 0) {
          <p-divider></p-divider>
          <div class="profession-quests-section">
            <div class="profession-header">
              <span class="profession-title">Profession Knowledge Quests</span>
              <p-badge
                [value]="completedProfessionQuests() + '/' + professionQuestProgress().length"
                severity="info">
              </p-badge>
            </div>
            @for (prof of professionQuestProgress(); track prof.profession) {
              <div class="quest-item profession-quest">
                <div class="quest-info">
                  <i class="pi pi-book quest-icon"></i>
                  <div class="quest-details">
                    <span class="quest-name">{{ prof.profession }}</span>
                    <small class="quest-description">Weekly knowledge quest</small>
                  </div>
                </div>
                <p-checkbox
                  [ngModel]="prof.completed"
                  [binary]="true"
                  [disabled]="loading()"
                  (onChange)="onToggleProfessionQuest(prof.profession)">
                </p-checkbox>
              </div>
            }
          </div>
        }

        <!-- Weekly Quest Summary -->
        @if (weeklyQuestProgress().percentage === 100) {
          <p-message
            severity="success"
            styleClass="quest-complete-message">
            <span>All weekly quests completed! Great job!</span>
          </p-message>
        }
      </p-card>

    </div>
  } @else {
    <div class="no-character-selected">
      <p-card>
        <div class="empty-state">
          <i class="pi pi-user-plus"></i>
          <h3>No Character Selected</h3>
          <p>Select a character to view their weekly activity progress and Great Vault status.</p>
        </div>
      </p-card>
    </div>
  }

  @if (loading()) {
    <div class="loading-overlay">
      <i class="pi pi-spin pi-spinner"></i>
      <span>Loading activity data...</span>
    </div>
  }
</div>