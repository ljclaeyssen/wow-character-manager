<div class="dashboard-container">
  <!-- Dashboard Header -->
  <div class="dashboard-header p-d-flex p-flex-column p-gap-3">
    <div class="header-content p-d-flex p-flex-column p-gap-2">
      <h1>WoW Character Manager</h1>
      <div class="header-stats p-d-flex p-flex-wrap p-gap-3 p-justify-center p-md-justify-start">
        <div class="stat-item p-d-flex p-flex-column p-align-center p-text-center">
          <span class="stat-value">{{ dashboardStats().totalCharacters }}</span>
          <span class="stat-label">Characters</span>
        </div>
        <div class="stat-item p-d-flex p-flex-column p-align-center p-text-center">
          <span class="stat-value">{{ dashboardStats().totalActivities }}</span>
          <span class="stat-label">Weekly Activities</span>
        </div>
        <div class="stat-item p-d-flex p-flex-column p-align-center p-text-center">
          <span class="stat-value">{{ dashboardStats().averageVaultProgress }}%</span>
          <span class="stat-label">Avg Vault Progress</span>
        </div>
        <div class="stat-item p-d-flex p-flex-column p-align-center p-text-center">
          <span class="stat-value">{{ getNextResetTime() }}</span>
          <span class="stat-label">Until Reset</span>
        </div>
      </div>
    </div>

  </div>

  <!-- Main Content Area -->
  <div class="dashboard-main p-d-flex p-flex-column p-gap-4">
    <!-- Character Overview Panel -->
    <p-panel header="Character Overview" [toggleable]="true" styleClass="character-overview-panel">
      @if (characters().length > 0) {

        <!-- Replace p-dataView with simple grid -->
        <div class="character-grid">
          @for (character of enhancedCharacters(); track character.id) {
            <div class="character-card-wrapper">
              <p-card
                styleClass="character-summary-card"
                [class.selected]="selectedCharacter()?.id === character.id"
                (click)="onCharacterSelect(character)">

                <div class="character-header p-d-flex p-justify-between p-align-start p-gap-2">
                  <div class="character-info p-d-flex p-flex-column p-gap-2">
                    <h3 [style.color]="getClassColor(character.characterClass)">
                      {{ character.name }}
                    </h3>
                    <div class="character-details p-d-flex p-flex-wrap p-gap-1">
                      <p-tag
                        [value]="character.characterClass"
                        [severity]="'info'"
                        styleClass="class-tag">
                      </p-tag>
                      <p-tag
                        [value]="character.faction"
                        [severity]="getFactionSeverity(character.faction)"
                        styleClass="faction-tag">
                      </p-tag>
                    </div>
                  </div>

                  <div class="character-actions p-d-flex p-gap-1">
                    <p-button
                      icon="pi pi-pencil"
                      severity="info"
                      [text]="true"
                      size="small"
                      pTooltip="Edit Character"
                      (onClick)="onEditCharacter(character); $event.stopPropagation()">
                    </p-button>
                  </div>
                </div>

                <p-divider></p-divider>

                <div class="character-progress p-d-flex p-flex-column p-gap-3">
                  <div class="progress-item p-d-flex p-flex-column p-gap-2">
                    <span class="progress-label">Great Vault Progress</span>
                    <div class="progress-display p-d-flex p-align-center p-gap-2">
                      <span class="progress-value">{{ character.vaultProgress }}/9</span>
                      <p-progressBar
                        [value]="character.vaultPercentage"
                        [showValue]="false"
                        styleClass="vault-progress"
                        class="p-flex-1">
                      </p-progressBar>
                    </div>
                  </div>

                  <div class="progress-item p-d-flex p-justify-between p-align-center">
                    <span class="progress-label">Weekly Activities</span>
                    <p-badge
                      [value]="character.weeklyActivities"
                      [severity]="character.weeklyActivities > 0 ? 'success' : 'warn'"
                      size="large">
                    </p-badge>
                  </div>

                  @if (character.lastActivity) {
                    <div class="progress-item">
                      <span class="progress-label">Last Activity</span>
                      <span class="last-activity">{{ formatRelativeTime(character.lastActivity) }}</span>
                    </div>
                  }
                </div>
              </p-card>
            </div>
          }
        </div>
      } @else {
        <div class="no-characters">
          <i class="pi pi-users"></i>
          <h3>No Characters Created</h3>
          <p>Create your first character to start tracking your WoW progress!</p>
          <p-button
            label="View Characters"
            icon="pi pi-users"
            severity="info"
            routerLink="/characters">
          </p-button>
        </div>
      }
    </p-panel>

    <!-- Activity Tracking Panel -->
    @if (selectedCharacter()) {
      <p-panel
        [header]="'Activity Tracking - ' + selectedCharacter()!.name"
        [toggleable]="true"
        styleClass="activity-tracking-panel">

        <div class="activity-panels">
          <p-panel header="Overview" [toggleable]="true">
            <wow-activity-tracker
              [selectedCharacter]="selectedCharacter()">
            </wow-activity-tracker>
          </p-panel>

          <p-panel header="Mythic+" [toggleable]="true">
            <wow-mythic-plus
              [selectedCharacter]="selectedCharacter()">
            </wow-mythic-plus>
          </p-panel>

          <p-panel header="Raids" [toggleable]="true">
            <wow-raid-progress
              [selectedCharacter]="selectedCharacter()">
            </wow-raid-progress>
          </p-panel>

          <p-panel header="Weekly Quests" [toggleable]="true">
            <wow-weekly-quest
              [selectedCharacter]="selectedCharacter()">
            </wow-weekly-quest>
          </p-panel>

          @if (selectedCharacter()) {
            <p-panel header="Character Details" [toggleable]="true">
              <div class="character-detail-placeholder">
                <p>Character details are available on the dedicated character detail page.</p>
                <p-button
                  label="View Full Details"
                  icon="pi pi-eye"
                  severity="info"
                  (onClick)="viewCharacterDetails(selectedCharacter()!)">
                </p-button>
              </div>
            </p-panel>
          }
        </div>
      </p-panel>
    } @else {
      <p-panel header="Select a Character" styleClass="no-selection-panel">
        <div class="no-selection">
          <i class="pi pi-hand-point-up"></i>
          <h3>Select a Character Above</h3>
          <p>Choose a character from the overview to view their detailed activity tracking and progress.</p>
        </div>
      </p-panel>
    }

    <!-- Quick Stats Panel -->
    @if (dashboardStats().totalCharacters > 0) {
      <p-panel header="Weekly Summary" [toggleable]="true" [collapsed]="true" styleClass="summary-panel">
        <div class="summary-grid">
          <div class="summary-item">
            <i class="pi pi-users summary-icon"></i>
            <div class="summary-content">
              <span class="summary-value">{{ dashboardStats().totalCharacters }}</span>
              <span class="summary-label">Total Characters</span>
            </div>
          </div>

          <div class="summary-item">
            <i class="pi pi-chart-bar summary-icon"></i>
            <div class="summary-content">
              <span class="summary-value">{{ dashboardStats().totalActivities }}</span>
              <span class="summary-label">Weekly Activities</span>
            </div>
          </div>

          <div class="summary-item">
            <i class="pi pi-star summary-icon"></i>
            <div class="summary-content">
              <span class="summary-value">{{ dashboardStats().charactersWithFullVault }}</span>
              <span class="summary-label">Full Vault Complete</span>
            </div>
          </div>

          @if (dashboardStats().mostActiveCharacter) {
            <div class="summary-item">
              <i class="pi pi-trophy summary-icon"></i>
              <div class="summary-content">
                <span class="summary-value">{{ dashboardStats().mostActiveCharacter!.name }}</span>
                <span class="summary-label">Most Active</span>
              </div>
            </div>
          }
        </div>
      </p-panel>
    }
  </div>


  <!-- Loading States -->
  @if (charactersLoading() || activitiesLoading()) {
    <div class="loading-overlay">
      <i class="pi pi-spin pi-spinner"></i>
      <span>Loading dashboard data...</span>
    </div>
  }
</div>